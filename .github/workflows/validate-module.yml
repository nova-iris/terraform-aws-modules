name: Validate Module

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to validate'
        required: true
        type: choice
        options:
          - vpc
          - ec2
          - ecs
          - lambda
          - s3
      ref:
        description: 'Git ref to validate'
        required: false
        default: ''
        type: string
  workflow_call:
    inputs:
      module:
        description: 'Module to validate'
        required: true
        type: string
      ref:
        description: 'Git ref to validate'
        required: false
        type: string
        default: ''

jobs:
  validate-module:
    name: Validate ${{ inputs.module }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        example: ['basic', 'advanced', 'complete']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.sha }}
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Validate Module Format
      id: fmt
      working-directory: modules/${{ inputs.module }}
      run: terraform fmt -check
      continue-on-error: true

    - name: Validate Module Syntax
      id: validate-module
      working-directory: modules/${{ inputs.module }}
      run: |
        terraform init -upgrade
        terraform validate -no-color
      continue-on-error: true

    - name: Validate Examples
      id: validate-example
      working-directory: modules/${{ inputs.module }}/examples/${{ matrix.example }}
      run: |
        # Check if example directory exists
        if [[ ! -f "main.tf" ]]; then
          echo "Example ${{ matrix.example }} not found for module ${{ inputs.module }}"
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Initialize and validate
        terraform init -upgrade
        terraform validate -no-color
        echo "skip=false" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Comment on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const module = '${{ inputs.module }}';
          const example = '${{ matrix.example }}';
          
          let message = `âŒ **${{ inputs.module }} module validation failed**\n\n`;
          message += `- **Example**: ${example}\n`;
          message += `- **Module**: ${module}\n\n`;
          
          if ('${{ steps.fmt.outcome }}' === 'failure') {
            message += `- **Format Check**: Failed\n`;
          }
          if ('${{ steps.validate-module.outcome }}' === 'failure') {
            message += `- **Module Validation**: Failed\n`;
          }
          if ('${{ steps.validate-example.outcome }}' === 'failure' && '${{ steps.validate-example.outputs.skip }}' !== 'true') {
            message += `- **Example Validation**: Failed\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

    - name: Upload Results
      if: always() && steps.validate-example.outputs.skip != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.module }}-${{ matrix.example }}
        path: |
          modules/${{ inputs.module }}/.terraform/
          modules/${{ inputs.module }}/examples/${{ matrix.example }}/.terraform/
          modules/${{ inputs.module }}/examples/${{ matrix.example }}/tfplan.*
        retention-days: 3

    - name: Summary
      if: always()
      run: |
        echo "## ${{ inputs.module }} Module Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Module**: ${{ inputs.module }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Example**: ${{ matrix.example }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Format Check**: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Module Validation**: ${{ steps.validate-module.outcome }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.validate-example.outputs.skip }}" == "true" ]]; then
          echo "- **Example Validation**: Skipped (example not found)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Example Validation**: ${{ steps.validate-example.outcome }}" >> $GITHUB_STEP_SUMMARY
        fi