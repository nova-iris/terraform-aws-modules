name: Validate All Modules

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-all:
    name: Validate All Modules
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module: ['vpc', 'ec2', 'ecs', 'lambda', 's3']
        terraform-version: ['1.5', '1.6', 'latest']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ matrix.terraform-version }}

    - name: Validate Module Format
      id: fmt
      working-directory: modules/${{ matrix.module }}
      run: terraform fmt -check
      continue-on-error: true

    - name: Validate Module Syntax
      id: validate-module
      working-directory: modules/${{ matrix.module }}
      run: |
        terraform init -upgrade
        terraform validate -no-color
      continue-on-error: true

    - name: Validate and Plan All Examples
      id: validate-examples
      working-directory: modules/${{ matrix.module }}
      run: |
        echo "Validating all examples for ${{ matrix.module }}..."
        
        for example_dir in examples/*/; do
          if [[ -f "${example_dir}main.tf" ]]; then
            example_name=$(basename "$example_dir")
            echo "Validating example: $example_name"
            
            cd "$example_dir"
            terraform init -upgrade
            terraform validate -no-color
            cd ../..
          fi
        done

    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.module }}-validation-${{ matrix.terraform-version }}
        path: |
          modules/${{ matrix.module }}/.terraform/
          modules/${{ matrix.module }}/examples/**/.terraform/
        retention-days: 1

    - name: Summary
      if: always()
      run: |
        echo "## ${{ matrix.module }} Module Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Module**: ${{ matrix.module }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Terraform Version**: ${{ matrix.terraform-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Format Check**: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Module Validation**: ${{ steps.validate-module.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Examples Validation**: ${{ steps.validate-examples.outcome }}" >> $GITHUB_STEP_SUMMARY
  